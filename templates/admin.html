<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - LeAIrn</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="shortcut icon" type="image/png" href="/static/favicon.png">
    <link rel="apple-touch-icon" href="/static/favicon.png">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .admin-body {
            background: var(--bg);
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .admin-header {
            max-width: 1400px;
            margin: 0 auto 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .admin-brand h1 {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .admin-brand p {
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .admin-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .admin-actions button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-refresh {
            background: var(--surface);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-refresh:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-export {
            background: var(--primary);
            color: white;
        }

        .btn-export:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-logout {
            background: var(--error);
            color: white;
        }

        .btn-logout:hover {
            opacity: 0.9;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        .table-card {
            background: var(--surface);
            border-radius: 1rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
        }

        .table-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .table-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        thead {
            background: var(--bg);
        }

        th {
            padding: 0.875rem 0.75rem;
            text-align: left;
            font-weight: 700;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        td {
            padding: 0.875rem 0.75rem;
            border-top: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        tr:hover {
            background: var(--bg);
        }

        /* Action buttons in table - make it sticky and wider */
        th:last-child,
        td:last-child {
            position: sticky;
            right: 0;
            background: var(--surface);
            min-width: 280px;
            width: 280px;
            padding-right: 1rem;
            box-shadow: -4px 0 6px rgba(0, 0, 0, 0.08);
            z-index: 10;
        }

        thead th:last-child {
            z-index: 20;
        }

        tr:hover td:last-child {
            background: var(--bg);
        }

        /* Ensure action buttons fit properly */
        td:last-child > div {
            display: flex;
            gap: 0.25rem;
            justify-content: flex-start;
            flex-wrap: nowrap;
        }

        /* Make other columns more compact */
        td:nth-child(5),
        td:nth-child(6) {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .badge {
            padding: 0.35rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge-role {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-tertiary);
        }

        /* Modal Styles */
        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        .admin-modal-content {
            background: var(--surface);
            border-radius: 1.25rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow:
                0 25px 50px -12px rgba(0, 0, 0, 0.5),
                0 0 0 1px var(--border);
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .admin-modal-header {
            padding: 2.5rem 2.5rem 2rem;
            border-bottom: 2px solid var(--border);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
        }

        .admin-modal-header h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .admin-modal-header h2::before {
            content: '';
            width: 4px;
            height: 1.75rem;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 2px;
        }

        .admin-modal-body {
            padding: 2.5rem;
        }

        .admin-form-group {
            margin-bottom: 1.5rem;
        }

        .admin-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .admin-form-group input,
        .admin-form-group select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 0.625rem;
            background: var(--bg);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .admin-form-group input:hover,
        .admin-form-group select:hover {
            border-color: var(--text-tertiary);
        }

        .admin-form-group input:focus,
        .admin-form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .admin-form-hint {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        .admin-modal-footer {
            padding: 1.5rem 2rem;
            border-top: 2px solid var(--border);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .admin-modal-footer button {
            padding: 0.875rem 1.75rem;
            border-radius: 0.625rem;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-modal-cancel {
            background: var(--bg);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-modal-cancel:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        .btn-modal-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-modal-primary:hover {
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
            transform: translateY(-2px);
        }

        .btn-modal-primary:active {
            transform: translateY(0);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Time Slot Grid Improvements */
        .slots-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
        }

        .slot-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            transition: all 0.3s;
        }

        .slot-card.available {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .slot-card.booked {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .slot-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .slot-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .slot-status.available {
            background: var(--success);
            color: white;
        }

        .slot-status.booked {
            background: var(--error);
            color: white;
        }

        .slot-info {
            margin: 1rem 0;
        }

        .slot-day {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .slot-date {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .slot-time {
            font-weight: 600;
            color: var(--primary);
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        .slot-booked-by {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-top: 0.5rem;
        }

        .slot-actions {
            margin-top: 1rem;
        }

        .slot-actions button {
            width: 100%;
            padding: 0.5rem;
            background: transparent;
            color: var(--error);
            border: 2px solid var(--error);
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .slot-actions button:hover {
            background: var(--error);
            color: white;
        }

        /* Add Time Slot Button */
        .btn-add-slot {
            padding: 0.875rem 1.75rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 0.625rem;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-add-slot:hover {
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
            transform: translateY(-2px);
        }

        .btn-add-slot:active {
            transform: translateY(0);
        }

        .btn-add-slot svg {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-add-slot:hover svg {
            transform: rotate(90deg);
        }

        /* Generate Slots Button */
        .btn-generate-slots {
            padding: 0.875rem 1.75rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 0.625rem;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .btn-generate-slots:hover {
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
            transform: translateY(-2px);
        }

        .btn-generate-slots:active {
            transform: translateY(0);
        }

        /* Loading Spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-loading {
            opacity: 0.7;
            cursor: not-allowed !important;
            pointer-events: none;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 1024px) {
            .admin-body {
                padding: 1rem 0.5rem;
            }

            .admin-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .admin-actions {
                justify-content: stretch;
            }

            .admin-actions button {
                flex: 1;
                justify-content: center;
            }

            /* Make tables horizontally scrollable */
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table-wrapper table {
                min-width: 800px;
            }

            /* Stack action buttons vertically on mobile */
            td:last-child > div {
                flex-direction: column !important;
                gap: 0.4rem !important;
            }

            td:last-child button {
                min-width: 100% !important;
                width: 100%;
            }

            /* Hide less important columns on small screens */
            @media (max-width: 768px) {
                th:nth-child(4), /* Department */
                td:nth-child(4),
                th:nth-child(6), /* Primary Use */
                td:nth-child(6),
                th:nth-child(8), /* Location */
                td:nth-child(8) {
                    display: none;
                }
            }

            /* Feedback table mobile adjustments */
            .table-card:has(#feedbackTable) td:first-child {
                min-width: 150px;
            }

            .table-card:has(#feedbackTable) td:nth-child(2) {
                min-width: 120px;
            }
        }

        /* Expandable feedback viewer */
        .feedback-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 1rem;
        }

        .feedback-modal.active {
            display: flex;
        }

        .feedback-modal-content {
            background: var(--surface);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .feedback-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1.5rem;
        }

        .feedback-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .feedback-modal-close:hover {
            background: var(--border);
            color: var(--text-primary);
        }
    </style>
</head>
<body class="admin-body">
    <div class="admin-header">
        <div class="admin-brand">
            <h1>LeAIrn</h1>
            <p>Admin Dashboard</p>
        </div>
        <div class="admin-actions">
            <button class="btn-refresh" onclick="loadUsers(); loadTimeSlots();">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                Refresh
            </button>
            <button class="btn-export" onclick="exportCSV()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export CSV
            </button>
            <button class="btn-logout" onclick="logout()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                Logout
            </button>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Total Bookings</div>
                        <div class="stat-value" id="totalBookings">0</div>
                    </div>
                    <div class="stat-icon" style="background: rgba(99, 102, 241, 0.1); color: var(--primary);">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                            <path d="M16 3.13a4 4 0 010 7.75"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">Students</div>
                        <div class="stat-value" id="totalStudents">0</div>
                    </div>
                    <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--success);">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                            <path d="M6 12v5c3 3 9 3 12 0v-5"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-label">This Week</div>
                        <div class="stat-value" id="thisWeek">0</div>
                    </div>
                    <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #F59E0B;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-card">
            <div class="table-header">
                <h2>All Bookings</h2>
                <p>Manage all AI learning session bookings</p>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Dept/Major</th>
                            <th>AI Level</th>
                            <th>Primary Use</th>
                            <th>Time Slot</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTable">
                        <tr>
                            <td colspan="9" class="empty-state">
                                <div class="spinner"></div>
                                <p>Loading bookings...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Time Slot Management Section -->
        <div class="table-card" style="margin-top: 2rem;">
            <div class="table-header" style="cursor: pointer;" onclick="toggleSlotsSection()">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <svg id="slotsChevron" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                        <div>
                            <h2 style="margin: 0;">Manage Time Slots</h2>
                            <p style="margin: 0.25rem 0 0 0;">Add, view, or remove available time slots</p>
                        </div>
                    </div>
                    <div id="slotsActionButtons" style="display: flex; gap: 1rem; flex-wrap: wrap;" onclick="event.stopPropagation()">
                        <button class="btn-generate-slots" onclick="showGenerateSlotsModal()" style="margin: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                            Generate Recurring Slots
                        </button>
                        <button class="btn-add-slot" onclick="showAddSlotModal()" style="margin: 0;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add Single Slot
                        </button>
                        <button onclick="showBulkDeleteModal()" style="margin: 0; padding: 0.875rem 1.75rem; border-radius: 0.75rem; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.3s; border: none; display: inline-flex; align-items: center; gap: 0.625rem; background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); color: white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Bulk Delete
                        </button>
                    </div>
                </div>
            </div>
            <div id="slotsManagement" style="max-height: 0; overflow: hidden; opacity: 0; transition: max-height 0.3s ease-out, opacity 0.3s ease-out;">
                <div style="padding: 2rem;">
                    <div class="loading-container">
                        <div class="spinner"></div>
                        <p>Loading time slots...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feedback Section -->
        <div class="table-card" style="margin-top: 2rem;">
            <div class="table-header">
                <h2>Session Feedback</h2>
                <p>View ratings and comments from completed sessions</p>
            </div>

            <!-- Overall Feedback Summary -->
            <div id="feedbackSummary" style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p style="font-size: 0.9rem;">Loading summary...</p>
                </div>
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Rating</th>
                            <th>Comments</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="feedbackTable">
                        <tr>
                            <td colspan="4" class="empty-state">
                                <div class="spinner"></div>
                                <p>Loading feedback...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Session Overviews Section -->
        <div class="table-card" style="margin-top: 2rem;">
            <div class="table-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2>Session Overviews</h2>
                    <p>View notes and summaries from completed sessions</p>
                </div>
                <button onclick="showManualOverviewModal()" style="width: 44px; height: 44px; background: var(--primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" title="Add Manual Overview">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Session Date</th>
                            <th>Notes Preview</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="overviewsTable">
                        <tr>
                            <td colspan="5" class="empty-state">
                                <div class="spinner"></div>
                                <p>Loading session overviews...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
        });

        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (!response.ok) throw new Error('Failed to load data');

                const users = await response.json();

                // Update stats
                document.getElementById('totalBookings').textContent = users.length;
                document.getElementById('totalStudents').textContent = users.filter(u => u.role === 'student').length;

                const now = new Date();
                const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                const thisWeekCount = users.filter(u => {
                    const submissionDate = new Date(u.submission_date);
                    return submissionDate >= weekStart;
                }).length;
                document.getElementById('thisWeek').textContent = thisWeekCount;

                // Populate table
                const tbody = document.getElementById('bookingsTable');

                if (users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <p>No bookings yet</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = '';
                users.forEach((user, index) => {
                    const row = document.createElement('tr');
                    const submissionDate = new Date(user.submission_date);

                    const aiLevel = user.ai_familiarity || 'N/A';
                    const primaryUse = user.primary_use || 'N/A';

                    row.innerHTML = `
                        <td><strong>${user.full_name}</strong></td>
                        <td>${user.email}</td>
                        <td><span class="badge badge-role">${user.role}</span></td>
                        <td><span class="badge" style="background: rgba(139, 92, 246, 0.1); color: #8B5CF6;">${aiLevel}</span></td>
                        <td>${primaryUse}</td>
                        <td>${formatSlotId(user.selected_slot)}</td>
                        <td>${user.selected_room || 'Not specified'}</td>
                        <td>
                            <button class="btn-view" onclick="viewUserDetails(${index})" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.85rem;">
                                View Details
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('bookingsTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state" style="color: var(--error);">
                            <p>Error loading bookings. Please try again.</p>
                        </td>
                    </tr>
                `;
            }
        }

        function formatSlotId(slotId) {
            const year = slotId.substring(0, 4);
            const month = slotId.substring(4, 6);
            const day = slotId.substring(6, 8);
            const hour = slotId.substring(8, 10);
            const minute = slotId.substring(10, 12);

            const date = new Date(year, month - 1, day, hour, minute);
            return date.toLocaleString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        function exportCSV() {
            window.location.href = '/api/export/csv';
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/admin/logout';
            }
        }

        let allUsers = [];

        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (!response.ok) throw new Error('Failed to load data');

                allUsers = await response.json();
                displayUsers(allUsers);
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('bookingsTable').innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state" style="color: var(--error);">
                            <p>Error loading bookings. Please try again.</p>
                        </td>
                    </tr>
                `;
            }
        }

        function displayUsers(users) {
            // Update stats
            document.getElementById('totalBookings').textContent = users.length;
            document.getElementById('totalStudents').textContent = users.filter(u => u.role === 'student').length;

            const now = new Date();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            const thisWeekCount = users.filter(u => {
                const submissionDate = new Date(u.submission_date);
                return submissionDate >= weekStart;
            }).length;
            document.getElementById('thisWeek').textContent = thisWeekCount;

            // Populate table
            const tbody = document.getElementById('bookingsTable');

            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <p>No bookings yet</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';
            users.forEach((user, index) => {
                const row = document.createElement('tr');

                const aiLevel = user.ai_familiarity || 'N/A';
                const primaryUse = user.primary_use || 'N/A';
                const department = user.department || 'N/A';

                row.innerHTML = `
                    <td><strong>${user.full_name}</strong></td>
                    <td>${user.email}</td>
                    <td><span class="badge badge-role">${user.role}</span></td>
                    <td>${department}</td>
                    <td><span class="badge" style="background: rgba(139, 92, 246, 0.1); color: #8B5CF6;">${aiLevel}</span></td>
                    <td title="${primaryUse}">${primaryUse}</td>
                    <td style="white-space: nowrap;">${formatSlotId(user.selected_slot)}</td>
                    <td>${user.selected_room || 'Not specified'}</td>
                    <td>
                        <div style="display: flex; gap: 0.25rem; flex-wrap: nowrap;">
                            <button onclick="viewUserDetails(${index})" title="View Details" style="flex: 1; min-width: 50px; padding: 0.45rem 0.5rem; background: var(--primary); color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.75rem; font-weight: 600; white-space: nowrap; transition: all 0.2s;">
                                View
                            </button>
                            <button onclick="editBooking(${index})" title="Edit Booking" style="flex: 1; min-width: 45px; padding: 0.45rem 0.5rem; background: #F59E0B; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.75rem; font-weight: 600; white-space: nowrap; transition: all 0.2s;">
                                Edit
                            </button>
                            <button onclick="markComplete(${index})" title="Mark Complete & Send Feedback" style="flex: 1; min-width: 40px; padding: 0.5rem; background: #10B981; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 1.25rem; font-weight: 600; white-space: nowrap; transition: all 0.2s;">
                                ✓
                            </button>
                            <button onclick="deleteBooking(${index})" title="Delete Booking" style="flex: 1; min-width: 55px; padding: 0.45rem 0.5rem; background: var(--error); color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.75rem; font-weight: 600; white-space: nowrap; transition: all 0.2s;">
                                Delete
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function markComplete(index) {
            const user = allUsers[index];
            showSessionNotesModal(user, index);
        }

        function showSessionNotesModal(user, index) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 1rem;
            `;

            modal.innerHTML = `
                <div style="background: var(--surface); border-radius: 1rem; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem;">
                    <h2 style="margin-bottom: 0.5rem; color: var(--text-primary);">Complete Session: ${user.full_name}</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Add session notes for your records and send a summary to the student.</p>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">Session Notes (Optional)</label>
                        <textarea id="sessionNotes" placeholder="What did you cover? What tools did you teach? What prompting techniques? What should they practice?..." style="width: 100%; min-height: 200px; padding: 1rem; border: 2px solid var(--border); border-radius: 0.75rem; font-family: inherit; font-size: 0.95rem; resize: vertical; background: var(--bg); color: var(--text-primary);"></textarea>
                        <small style="display: block; margin-top: 0.5rem; color: var(--text-tertiary);">Notes will be formatted and sent to the student.</small>

                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem; cursor: pointer;">
                            <input type="checkbox" id="skipAI" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: var(--text-primary); font-weight: 500;">Send without AI enhancement (use raw notes as-is)</span>
                        </label>
                    </div>

                    <div style="background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem;">
                        <strong style="color: var(--primary);">What happens next:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--text-secondary);">
                            <li id="aiEnhanceText">Session notes will be enhanced with AI and emailed to student</li>
                            <li>Feedback request will be sent to student</li>
                            <li>Notes will be saved to your records</li>
                            <li>Booking will be marked complete and removed</li>
                        </ul>
                    </div>

                    <div style="display: flex; gap: 0.75rem;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="flex: 1; padding: 0.875rem; background: var(--bg); border: 2px solid var(--border); border-radius: 0.75rem; cursor: pointer; font-weight: 600; color: var(--text-primary);">
                            Cancel
                        </button>
                        <button onclick="submitSessionComplete(${index}, this.parentElement.parentElement.parentElement)" id="submitCompleteBtn" style="flex: 1; padding: 0.875rem; background: linear-gradient(135deg, #10B981, #059669); color: white; border: none; border-radius: 0.75rem; cursor: pointer; font-weight: 600; font-size: 1rem;">
                            Complete Session
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.getElementById('sessionNotes').focus();

            // Update text when checkbox changes
            document.getElementById('skipAI').addEventListener('change', function() {
                const textElement = document.getElementById('aiEnhanceText');
                if (this.checked) {
                    textElement.textContent = 'Raw notes will be sent to student as-is (no AI formatting)';
                } else {
                    textElement.textContent = 'Session notes will be enhanced with AI and emailed to student';
                }
            });
        }

        async function submitSessionComplete(index, modal) {
            const user = allUsers[index];
            const notes = document.getElementById('sessionNotes').value.trim();
            const skipAI = document.getElementById('skipAI').checked;
            const submitBtn = document.getElementById('submitCompleteBtn');

            // Disable button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 0.5rem;"><span class="spinner" style="border-width: 2px; width: 16px; height: 16px;"></span>Processing...</span>';

            try {
                const response = await fetch(`/api/booking/${user.id}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        notes: notes,
                        skip_ai: skipAI
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    modal.remove();
                    alert(`Session completed!\\n\\n${notes ? '✓ Session overview sent to student\\n' : ''}✓ Feedback request sent\\n✓ Booking removed`);
                    loadUsers();
                    loadTimeSlots();
                } else {
                    alert('Error: ' + (result.message || 'Failed to mark complete'));
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Complete Session';
                }
            } catch (error) {
                console.error('Error marking complete:', error);
                alert('Failed to mark session complete: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Complete Session';
            }
        }

        async function deleteBooking(index) {
            const user = allUsers[index];
            if (!confirm(`Are you sure you want to delete the booking for ${user.full_name}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/booking/${user.id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                console.log('Delete response:', response.ok, result);

                if (response.ok) {
                    if (result.success) {
                        alert('Booking deleted successfully!');
                        loadUsers();
                        loadTimeSlots();
                    } else {
                        alert('Error: ' + (result.message || 'Unknown error'));
                    }
                } else {
                    alert('Error: ' + (result.message || 'Failed to delete booking'));
                }
            } catch (error) {
                console.error('Error deleting booking:', error);
                alert('Failed to delete booking: ' + error.message);
            }
        }

        async function editBooking(index) {
            const user = allUsers[index];

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0, 0, 0, 0.7); display: flex;
                align-items: center; justify-content: center; z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: var(--surface); border-radius: 1rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 2rem; position: relative;">
                    <h2 style="margin-bottom: 1.5rem;">Edit Booking - ${user.full_name}</h2>

                    <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Name</label>
                            <input id="edit_name" type="text" value="${user.full_name}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem; background: var(--bg); color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Email</label>
                            <input id="edit_email" type="email" value="${user.email}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem; background: var(--bg); color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Location</label>
                            <input id="edit_room" type="text" value="${user.selected_room}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem; background: var(--bg); color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Change Time Slot (Current: ${formatSlotId(user.selected_slot)})</label>
                            <select id="edit_slot" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem; background: var(--bg); color: var(--text-primary);">
                                <option value="${user.selected_slot}">Keep current time</option>
                            </select>
                            <small style="color: var(--text-tertiary); display: block; margin-top: 0.25rem;">Loading available time slots...</small>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 0.75rem 1.5rem; background: var(--bg); color: var(--text-primary); border: 2px solid var(--border); border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                            Cancel
                        </button>
                        <button onclick="saveBookingEdit('${user.id}', this.parentElement.parentElement.parentElement)" style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                            Save Changes
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Load available time slots
            try {
                const response = await fetch('/api/slots');
                const slots = await response.json();
                const select = document.getElementById('edit_slot');
                const small = select.nextElementSibling;

                slots.forEach(slot => {
                    const option = document.createElement('option');
                    option.value = slot.id;
                    option.textContent = `${slot.day}, ${slot.date} at ${slot.time}`;
                    select.appendChild(option);
                });

                small.textContent = `${slots.length} available time slots`;
            } catch (error) {
                console.error('Error loading slots:', error);
            }
        }

        async function saveBookingEdit(bookingId, modal) {
            const updatedData = {
                full_name: document.getElementById('edit_name').value,
                email: document.getElementById('edit_email').value,
                selected_room: document.getElementById('edit_room').value,
                selected_slot: document.getElementById('edit_slot').value
            };

            try {
                const response = await fetch(`/api/booking/${bookingId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('Booking updated successfully!');
                    modal.remove();
                    loadUsers();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating booking:', error);
                alert('Failed to update booking');
            }
        }

        // Helper functions to format user data for display
        function formatExperienceLevel(value) {
            const levels = {
                'new': "I'm completely new to AI",
                'casual': "I've tried AI a few times",
                'basic': 'I use AI sometimes',
                'practical': 'I use AI regularly',
                'advanced': "I'm very experienced with AI"
            };
            return levels[value] || value;
        }

        function formatAITools(tools) {
            if (!tools) return 'None';
            const toolNames = {
                'chatgpt': 'ChatGPT',
                'gemini': 'Google Gemini',
                'claude': 'Claude',
                'image_gen': 'Image Generators',
                'coding': 'Coding Assistants',
                'research': 'Research & Search',
                'video': 'Video & Audio',
                'writing': 'Writing Assistants',
                'productivity': 'Productivity Tools',
                'none': 'None yet'
            };
            return tools.split(', ').map(tool => toolNames[tool] || tool).join(', ');
        }

        function formatPrimaryUse(uses) {
            if (!uses) return 'N/A';
            const useNames = {
                'writing': 'Writing & Content',
                'coding': 'Coding & Programming',
                'research': 'Research & Analysis',
                'creative': 'Creative Projects',
                'productivity': 'Productivity & Organization',
                'education': 'School & Studying',
                'business': 'Work & Professional',
                'not_sure': 'Not sure yet'
            };
            return uses.split(', ').map(use => useNames[use] || use).join(', ');
        }

        function formatLearningGoals(goals) {
            if (!goals) return 'N/A';
            const goalNames = {
                'use_tools': 'Get better at using AI',
                'understand': 'Understand how AI works',
                'build': 'Build my own AI projects',
                'integrate': 'Add AI to my projects',
                'career': 'Build career skills',
                'productivity': 'Work more efficiently',
                'explore': 'Just curious to learn'
            };
            return goals.split(', ').map(goal => goalNames[goal] || goal).join(', ');
        }

        function formatConfidenceLevel(value) {
            const levels = {
                '1': 'Not confident',
                '2': 'A little comfortable',
                '3': 'Somewhat comfortable',
                '4': 'Very comfortable',
                '5': 'Expert level'
            };
            return levels[value] || value;
        }

        async function viewUserDetails(index) {
            const user = allUsers[index];

            // Create modal HTML
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;

            const insightsContent = user.ai_insights || `
<div style="display: flex; align-items: center; gap: 0.75rem; justify-content: flex-start;">
    <div style="width: 20px; height: 20px; border: 2.5px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0;"></div>
    <div style="font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">Generating AI insights...</div>
</div>
            `;

            modal.innerHTML = `
                <div style="background: var(--surface); border-radius: 1rem; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 2rem; position: relative; box-shadow: var(--shadow-lg);">
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 1rem; right: 1rem; background: var(--bg); border: 2px solid var(--border); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.5rem; color: var(--text-secondary);">×</button>

                    <h2 style="margin-bottom: 1.5rem; color: var(--text-primary);">${user.full_name} - Session Details</h2>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="background: var(--bg); padding: 1rem; border-radius: 0.75rem; border: 1px solid var(--border);">
                            <div style="font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">Email</div>
                            <div style="font-weight: 600;">${user.email}</div>
                        </div>
                        <div style="background: var(--bg); padding: 1rem; border-radius: 0.75rem; border: 1px solid var(--border);">
                            <div style="font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">Role</div>
                            <div style="font-weight: 600; text-transform: capitalize;">${user.role}</div>
                        </div>
                        <div style="background: var(--bg); padding: 1rem; border-radius: 0.75rem; border: 1px solid var(--border);">
                            <div style="font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">${user.role === 'student' ? 'Major' : 'Department'}</div>
                            <div style="font-weight: 600;">${user.department || 'Not specified'}</div>
                        </div>
                        <div style="background: var(--bg); padding: 1rem; border-radius: 0.75rem; border: 1px solid var(--border);">
                            <div style="font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">Booking Time</div>
                            <div style="font-weight: 600;">${user.slot_details ? `${user.slot_details.day}, ${user.slot_details.date} at ${user.slot_details.time}` : formatSlotId(user.selected_slot)}</div>
                        </div>
                        <div style="background: var(--bg); padding: 1rem; border-radius: 0.75rem; border: 1px solid var(--border);">
                            <div style="font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">Location</div>
                            <div style="font-weight: 600;">${user.selected_room}</div>
                        </div>
                    </div>

                    <h3 style="margin: 2rem 0 1rem; color: var(--text-primary);">AI Experience Profile</h3>
                    <div style="background: rgba(99, 102, 241, 0.05); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid rgba(99, 102, 241, 0.2); margin-bottom: 2rem;">
                        <div style="display: grid; gap: 1rem;">
                            <div><strong>Experience Level:</strong> ${formatExperienceLevel(user.ai_familiarity)}</div>
                            <div><strong>AI Tools Used:</strong> ${formatAITools(user.ai_tools)}</div>
                            <div><strong>Primary Use:</strong> ${formatPrimaryUse(user.primary_use)}</div>
                            <div><strong>Learning Goals:</strong> ${formatLearningGoals(user.learning_goal)}</div>
                            <div><strong>Confidence Level:</strong> ${formatConfidenceLevel(user.confidence_level)}</div>
                        </div>
                    </div>

                    ${user.personal_comments ? `
                    <h3 style="margin: 2rem 0 1rem; color: var(--text-primary);">${user.role === 'student' ? "Student's" : user.role === 'teacher' ? "Teacher's" : user.role === 'advisor' ? "Advisor's" : "User's"} Comments</h3>
                    <div style="background: rgba(245, 158, 11, 0.05); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid rgba(245, 158, 11, 0.2); margin-bottom: 2rem;">
                        <div style="line-height: 1.6; white-space: pre-wrap; color: var(--text-primary);">${user.personal_comments}</div>
                    </div>
                    ` : ''}

                    <div style="display: flex; align-items: center; justify-content: space-between; margin: 2rem 0 1rem;">
                        <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.75rem;">
                            AI Teaching Insights
                            <span style="background: linear-gradient(135deg, #6366F1, #8B5CF6); padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-size: 0.75rem; color: white; font-weight: 700;">Powered by Gemini</span>
                        </h3>
                        <button id="refresh-insights-btn" onclick="regenerateInsights(${index})" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s;" title="Generate new insights">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                            </svg>
                            Refresh
                        </button>
                    </div>
                    <div id="insights-container" style="background: var(--bg); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--border); line-height: 1.8; font-size: 0.95rem; ${user.ai_insights ? 'white-space: pre-wrap;' : ''}">
                        ${insightsContent}
                    </div>

                    <div style="margin-top: 2rem; text-align: right;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 0.75rem 2rem; background: var(--primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; font-size: 1rem;">
                            Close
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Generate insights if they don't exist
            if (!user.ai_insights) {
                try {
                    const response = await fetch(`/api/generate-insights/${user.id}`, {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        const insightsContainer = document.getElementById('insights-container');
                        if (insightsContainer) {
                            insightsContainer.style.whiteSpace = 'pre-wrap';
                            insightsContainer.textContent = result.insights;
                        }
                        // Update local cache
                        allUsers[index].ai_insights = result.insights;
                    } else {
                        const insightsContainer = document.getElementById('insights-container');
                        if (insightsContainer) {
                            insightsContainer.innerHTML = '<span style="color: var(--error);">Failed to generate AI insights. Please try again.</span>';
                        }
                    }
                } catch (error) {
                    console.error('Error generating insights:', error);
                    const insightsContainer = document.getElementById('insights-container');
                    if (insightsContainer) {
                        insightsContainer.innerHTML = '<span style="color: var(--error);">Error generating insights: ' + error.message + '</span>';
                    }
                }
            }
        }

        // Regenerate insights function
        async function regenerateInsights(index) {
            const user = allUsers[index];
            const refreshBtn = document.getElementById('refresh-insights-btn');
            const insightsContainer = document.getElementById('insights-container');

            if (!refreshBtn || !insightsContainer) return;

            // Disable button and show loading state
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                </svg>
                Generating...
            `;
            insightsContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">Generating new insights...</div>';

            try {
                const response = await fetch(`/api/generate-insights/${user.id}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    insightsContainer.style.whiteSpace = 'pre-wrap';
                    insightsContainer.textContent = result.insights;
                    // Update local cache
                    allUsers[index].ai_insights = result.insights;
                } else {
                    insightsContainer.innerHTML = '<span style="color: var(--error);">Failed to generate AI insights. Please try again.</span>';
                }
            } catch (error) {
                console.error('Error regenerating insights:', error);
                insightsContainer.innerHTML = '<span style="color: var(--error);">Error generating insights: ' + error.message + '</span>';
            } finally {
                // Re-enable button
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                    </svg>
                    Refresh
                `;
            }
        }

        // Time Slot Management Functions
        let allSlots = [];
        let slotsExpanded = false;

        function toggleSlotsSection() {
            const slotsContent = document.getElementById('slotsManagement');
            const chevron = document.getElementById('slotsChevron');

            slotsExpanded = !slotsExpanded;

            if (slotsExpanded) {
                slotsContent.style.maxHeight = '800px';
                slotsContent.style.overflowY = 'auto';
                slotsContent.style.opacity = '1';
                chevron.style.transform = 'rotate(180deg)';
                // Load slots when expanded for the first time
                if (allSlots.length === 0) {
                    loadTimeSlots();
                }
            } else {
                slotsContent.style.maxHeight = '0';
                slotsContent.style.overflowY = 'hidden';
                slotsContent.style.opacity = '0';
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        async function loadTimeSlots() {
            try {
                const response = await fetch('/api/slots/manage');
                if (!response.ok) throw new Error('Failed to load slots');

                allSlots = await response.json();
                displayTimeSlots(allSlots);
            } catch (error) {
                console.error('Error loading time slots:', error);
                document.getElementById('slotsManagement').innerHTML = `
                    <div style="padding: 2rem;">
                        <p style="color: var(--error); text-align: center;">Error loading time slots</p>
                    </div>
                `;
            }
        }

        function displayTimeSlots(slots) {
            const container = document.getElementById('slotsManagement');

            if (slots.length === 0) {
                container.innerHTML = '<div style="padding: 2rem;"><p style="text-align: center; color: var(--text-tertiary);">No time slots available</p></div>';
                return;
            }

            // Separate upcoming and past slots
            const now = new Date();
            const upcoming = slots.filter(s => new Date(s.datetime) > now).sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            const past = slots.filter(s => new Date(s.datetime) <= now);

            const pastUnbooked = past.filter(s => !s.booked).length;

            container.innerHTML = `
                <div style="padding: 2rem;">
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--surface); border-radius: 0.75rem; border: 1px solid var(--border);">
                        <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--text-tertiary);">Total Slots</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">${slots.length}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: var(--text-tertiary);">Upcoming</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #10B981;">${upcoming.length}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: var(--text-tertiary);">Past Slots</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-tertiary);">${past.length}</div>
                            </div>
                            ${pastUnbooked > 0 ? `
                            <div style="flex: 1; display: flex; align-items: center; justify-content: flex-end;">
                                <button onclick="cleanupOldSlots(event)" style="padding: 0.75rem 1.5rem; background: #F59E0B; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                                    Clean Up ${pastUnbooked} Old Slots
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Upcoming Time Slots (${upcoming.length})</h3>
                    <div class="slots-grid-container">
                        ${upcoming.map(slot => `
                            <div class="slot-card ${slot.booked ? 'booked' : 'available'}">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                                    <span class="slot-status ${slot.booked ? 'booked' : 'available'}">
                                        ${slot.booked ? 'Booked' : 'Available'}
                                    </span>
                                </div>
                                <div class="slot-info">
                                    <div class="slot-day">${slot.day}</div>
                                    <div class="slot-date">${slot.date}</div>
                                    <div class="slot-time">${slot.time}</div>
                                    ${slot.booked ? `<div class="slot-booked-by">Booked by: ${slot.booked_by}</div>` : ''}
                                </div>
                                ${!slot.booked ? `
                                    <div class="slot-actions">
                                        <button onclick="deleteSlot('${slot.id}')">
                                            Delete Slot
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function showGenerateSlotsModal() {
            const modal = document.createElement('div');
            modal.className = 'admin-modal';

            modal.innerHTML = `
                <div class="admin-modal-content">
                    <div class="admin-modal-header">
                        <h2>Generate Recurring Time Slots</h2>
                    </div>

                    <div class="admin-modal-body">
                        <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                            This will automatically generate your weekly time slots:
                        </p>
                        <ul style="margin-bottom: 1.5rem; color: var(--text-secondary); line-height: 1.8;">
                            <li><strong>Tuesday:</strong> 11:00 AM, 12:00 PM, 1:00 PM</li>
                            <li><strong>Wednesday:</strong> 2:00 PM, 3:00 PM</li>
                            <li><strong>Thursday:</strong> 12:00 PM, 1:00 PM</li>
                            <li><strong>Friday:</strong> 11:00 AM, 12:00 PM, 1:00 PM</li>
                        </ul>
                        <div class="admin-form-group">
                            <label>How many weeks ahead?</label>
                            <input id="weeks_ahead" type="number" value="6" min="1" max="52">
                            <small class="admin-form-hint">Generates slots for the next N weeks. Existing future slots will be preserved.</small>
                        </div>
                    </div>

                    <div class="admin-modal-footer">
                        <button class="btn-modal-cancel" onclick="this.parentElement.parentElement.parentElement.remove()">
                            Cancel
                        </button>
                        <button class="btn-modal-primary" onclick="generateRecurringSlots(this.parentElement.parentElement.parentElement)">
                            Generate Slots
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function generateRecurringSlots(modal) {
            const weeksAhead = parseInt(document.getElementById('weeks_ahead').value);

            if (weeksAhead < 1 || weeksAhead > 52) {
                alert('Please enter a number between 1 and 52 weeks');
                return;
            }

            // Get the button and show loading state
            const button = modal.querySelector('.btn-modal-primary');
            const originalContent = button.innerHTML;
            button.classList.add('btn-loading');
            button.innerHTML = '<span style="display: inline-flex; align-items: center;"><span class="spinner"></span>Generating...</span>';

            try {
                const response = await fetch('/api/slots/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ weeks_ahead: weeksAhead })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert(result.message);
                    modal.remove();
                    loadTimeSlots();
                } else {
                    alert('Error: ' + result.message);
                    button.classList.remove('btn-loading');
                    button.innerHTML = originalContent;
                }
            } catch (error) {
                console.error('Error generating slots:', error);
                alert('Failed to generate time slots');
                button.classList.remove('btn-loading');
                button.innerHTML = originalContent;
            }
        }

        function showAddSlotModal() {
            const modal = document.createElement('div');
            modal.className = 'admin-modal';

            const now = new Date();
            const minDatetime = now.toISOString().slice(0, 16);

            modal.innerHTML = `
                <div class="admin-modal-content">
                    <div class="admin-modal-header">
                        <h2>Add New Time Slot</h2>
                    </div>

                    <div class="admin-modal-body">
                        <div class="admin-form-group">
                            <label>Date and Time</label>
                            <input id="new_slot_datetime" type="datetime-local" min="${minDatetime}">
                            <small class="admin-form-hint">Select the date and time for the new time slot</small>
                        </div>
                    </div>

                    <div class="admin-modal-footer">
                        <button class="btn-modal-cancel" onclick="this.parentElement.parentElement.parentElement.remove()">
                            Cancel
                        </button>
                        <button class="btn-modal-primary" onclick="addNewSlot(this.parentElement.parentElement.parentElement)">
                            Add Time Slot
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function addNewSlot(modal) {
            const datetimeInput = document.getElementById('new_slot_datetime').value;

            if (!datetimeInput) {
                alert('Please select a date and time');
                return;
            }

            // Get the button and show loading state
            const button = modal.querySelector('.btn-modal-primary');
            const originalContent = button.innerHTML;
            button.classList.add('btn-loading');
            button.innerHTML = '<span style="display: inline-flex; align-items: center;"><span class="spinner"></span>Adding...</span>';

            try {
                const response = await fetch('/api/slots/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ datetime: datetimeInput })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('Time slot added successfully!');
                    modal.remove();
                    loadTimeSlots();
                } else {
                    alert('Error: ' + result.message);
                    button.classList.remove('btn-loading');
                    button.innerHTML = originalContent;
                }
            } catch (error) {
                console.error('Error adding time slot:', error);
                alert('Failed to add time slot');
                button.classList.remove('btn-loading');
                button.innerHTML = originalContent;
            }
        }

        async function cleanupOldSlots(event) {
            if (!confirm('This will delete ALL past time slots (both booked and unbooked). Continue?')) {
                return;
            }

            // Get the button and show loading state
            const button = event.target;
            const originalContent = button.innerHTML;
            button.classList.add('btn-loading');
            button.innerHTML = '<span style="display: inline-flex; align-items: center;"><span class="spinner" style="border-color: rgba(0, 0, 0, 0.3); border-top-color: #F59E0B;"></span>Cleaning...</span>';

            try {
                const response = await fetch('/api/slots/cleanup', {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert(result.message);
                    loadTimeSlots();
                } else {
                    alert('Error: ' + result.message);
                    button.classList.remove('btn-loading');
                    button.innerHTML = originalContent;
                }
            } catch (error) {
                console.error('Error cleaning up slots:', error);
                alert('Failed to clean up slots');
                button.classList.remove('btn-loading');
                button.innerHTML = originalContent;
            }
        }

        async function deleteSlot(slotId) {
            if (!confirm('Are you sure you want to delete this time slot?')) {
                return;
            }

            try {
                const response = await fetch(`/api/slots/${slotId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('Time slot deleted successfully!');
                    loadTimeSlots();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting time slot:', error);
                alert('Failed to delete time slot');
            }
        }

        // Bulk Delete Modal Functions
        function showBulkDeleteModal() {
            const modal = document.createElement('div');
            modal.className = 'admin-modal';

            modal.innerHTML = `
                <div class="admin-modal-content">
                    <div class="admin-modal-header">
                        <h2>Bulk Delete Time Slots</h2>
                    </div>

                    <div class="admin-modal-body">
                        <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                            Choose how you want to delete multiple slots:
                        </p>

                        <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                            <button onclick="switchDeleteMode('last_weeks')" id="btn-last-weeks" style="flex: 1; padding: 1rem; border: 2px solid var(--primary); background: var(--primary); color: white; border-radius: 0.75rem; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                Delete Last N Weeks
                            </button>
                            <button onclick="switchDeleteMode('select')" id="btn-select" style="flex: 1; padding: 1rem; border: 2px solid var(--border); background: transparent; color: var(--text-primary); border-radius: 0.75rem; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                Select Individually
                            </button>
                        </div>

                        <div id="delete-mode-content">
                            <div id="last-weeks-mode">
                                <div class="admin-form-group">
                                    <label>Delete slots after how many weeks from now?</label>
                                    <input id="delete_weeks" type="number" value="6" min="1" max="52">
                                    <small class="admin-form-hint">Example: Enter "6" to delete all slots that are more than 6 weeks away</small>
                                </div>
                            </div>

                            <div id="select-mode" style="display: none;">
                                <p style="margin-bottom: 1rem; color: var(--text-secondary);">Loading available slots...</p>
                                <div id="selectable-slots" style="max-height: 400px; overflow-y: auto; border: 2px solid var(--border); border-radius: 0.75rem; padding: 1rem;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="admin-modal-footer">
                        <button class="btn-modal-cancel" onclick="this.parentElement.parentElement.parentElement.remove()">
                            Cancel
                        </button>
                        <button class="btn-modal-primary" style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);" onclick="executeBulkDelete(this.parentElement.parentElement.parentElement)">
                            Delete Slots
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            loadSelectableSlots();
        }

        let currentDeleteMode = 'last_weeks';

        function switchDeleteMode(mode) {
            currentDeleteMode = mode;

            const btnLastWeeks = document.getElementById('btn-last-weeks');
            const btnSelect = document.getElementById('btn-select');
            const lastWeeksDiv = document.getElementById('last-weeks-mode');
            const selectDiv = document.getElementById('select-mode');

            if (mode === 'last_weeks') {
                btnLastWeeks.style.background = 'var(--primary)';
                btnLastWeeks.style.color = 'white';
                btnSelect.style.background = 'transparent';
                btnSelect.style.color = 'var(--text-primary)';
                lastWeeksDiv.style.display = 'block';
                selectDiv.style.display = 'none';
            } else {
                btnSelect.style.background = 'var(--primary)';
                btnSelect.style.color = 'white';
                btnLastWeeks.style.background = 'transparent';
                btnLastWeeks.style.color = 'var(--text-primary)';
                selectDiv.style.display = 'block';
                lastWeeksDiv.style.display = 'none';
            }
        }

        async function loadSelectableSlots() {
            try {
                const response = await fetch('/api/slots/manage');
                const slots = await response.json();

                const now = new Date();
                const availableSlots = slots.filter(s => !s.booked && new Date(s.datetime) > now)
                    .sort((a, b) => new Date(a.datetime) - new Date(b.datetime));

                const container = document.getElementById('selectable-slots');

                if (availableSlots.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-tertiary);">No available slots to delete</p>';
                    return;
                }

                container.innerHTML = availableSlots.map(slot => `
                    <div style="padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.5rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem; transition: all 0.3s;">
                        <input type="checkbox" value="${slot.id}" class="slot-checkbox" style="width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${slot.day}, ${slot.date}</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">${slot.time}</div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading slots:', error);
                document.getElementById('selectable-slots').innerHTML = '<p style="color: var(--error);">Error loading slots</p>';
            }
        }

        async function executeBulkDelete(modal) {
            // Get the button and prepare loading state
            const button = modal.querySelector('.btn-modal-primary');
            const originalContent = button.innerHTML;

            if (currentDeleteMode === 'last_weeks') {
                const weeks = parseInt(document.getElementById('delete_weeks').value);

                if (weeks < 1) {
                    alert('Please enter a valid number of weeks');
                    return;
                }

                if (!confirm(`This will delete all unbooked slots that are more than ${weeks} weeks from now. Continue?`)) {
                    return;
                }

                // Show loading state
                button.classList.add('btn-loading');
                button.innerHTML = '<span style="display: inline-flex; align-items: center;"><span class="spinner"></span>Deleting...</span>';

                try {
                    const response = await fetch('/api/slots/delete-range', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: 'last_weeks', weeks: weeks })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        alert(result.message);
                        modal.remove();
                        loadTimeSlots();
                    } else {
                        alert('Error: ' + result.message);
                        button.classList.remove('btn-loading');
                        button.innerHTML = originalContent;
                    }
                } catch (error) {
                    console.error('Error deleting slots:', error);
                    alert('Failed to delete slots');
                    button.classList.remove('btn-loading');
                    button.innerHTML = originalContent;
                }

            } else {
                const checkboxes = document.querySelectorAll('.slot-checkbox:checked');
                const slotIds = Array.from(checkboxes).map(cb => cb.value);

                if (slotIds.length === 0) {
                    alert('Please select at least one slot to delete');
                    return;
                }

                if (!confirm(`Delete ${slotIds.length} selected slot(s)?`)) {
                    return;
                }

                // Show loading state
                button.classList.add('btn-loading');
                button.innerHTML = '<span style="display: inline-flex; align-items: center;"><span class="spinner"></span>Deleting...</span>';

                try {
                    const response = await fetch('/api/slots/bulk-delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ slot_ids: slotIds })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        alert(result.message);
                        modal.remove();
                        loadTimeSlots();
                    } else {
                        alert('Error: ' + result.message);
                        button.classList.remove('btn-loading');
                        button.innerHTML = originalContent;
                    }
                } catch (error) {
                    console.error('Error deleting slots:', error);
                    alert('Failed to delete slots');
                    button.classList.remove('btn-loading');
                    button.innerHTML = originalContent;
                }
            }
        }

        async function loadFeedback() {
            try {
                const response = await fetch('/api/feedback');
                const feedbackList = await response.json();

                const tbody = document.getElementById('feedbackTable');
                tbody.innerHTML = '';

                if (feedbackList.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="empty-state"><p>No feedback received yet</p></td></tr>';
                    document.getElementById('feedbackSummary').innerHTML = '<div style="text-align: center; color: var(--text-tertiary); padding: 1rem;">No feedback data yet</div>';
                    return;
                }

                // Calculate and display summary stats
                displayFeedbackSummary(feedbackList);

                // Sort by timestamp, newest first
                feedbackList.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                feedbackList.forEach((feedback, index) => {
                    const row = document.createElement('tr');

                    // Format rating as stars
                    const stars = '⭐'.repeat(feedback.rating);

                    // Format date
                    const date = new Date(feedback.timestamp);
                    const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});

                    // Truncate comments if too long
                    let comments = feedback.comments || 'No comments';
                    const fullComments = comments;
                    const maxLength = 100;
                    let isTruncated = false;
                    if (comments.length > maxLength) {
                        comments = comments.substring(0, maxLength) + '...';
                        isTruncated = true;
                    }

                    // Get user info
                    const userName = feedback.user_name || 'Unknown User';
                    const userEmail = feedback.user_email || 'N/A';

                    // Store feedback data for modal
                    row.dataset.feedbackIndex = index;

                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${userName}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">${userEmail}</div>
                        </td>
                        <td>
                            <span style="font-size: 1.25rem;">${stars}</span>
                            <span style="margin-left: 0.5rem; font-weight: 600;">${feedback.rating}/5</span>
                        </td>
                        <td style="max-width: 400px;">
                            <div style="white-space: normal; line-height: 1.5; ${isTruncated ? 'cursor: pointer; color: var(--primary);' : ''}" ${isTruncated ? `onclick="showFeedbackModal(${JSON.stringify(feedback).replace(/"/g, '&quot;')})" title="Click to view full feedback"` : ''}>${comments}${isTruncated ? ' <span style="color: var(--primary); font-weight: 600;">(click to view)</span>' : ''}</div>
                        </td>
                        <td style="white-space: nowrap;">${formattedDate}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading feedback:', error);
                const tbody = document.getElementById('feedbackTable');
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state"><p>Error loading feedback</p></td></tr>';
            }
        }

        // Display feedback summary statistics
        function displayFeedbackSummary(feedbackList) {
            const summaryDiv = document.getElementById('feedbackSummary');

            // Calculate stats
            const totalFeedback = feedbackList.length;
            const totalRating = feedbackList.reduce((sum, f) => sum + f.rating, 0);
            const averageRating = (totalRating / totalFeedback).toFixed(1);

            // Count by rating
            const ratingCounts = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
            feedbackList.forEach(f => {
                if (ratingCounts.hasOwnProperty(f.rating)) {
                    ratingCounts[f.rating]++;
                }
            });

            const fiveStarCount = ratingCounts[5];
            const fourStarCount = ratingCounts[4];
            const positiveCount = fiveStarCount + fourStarCount;
            const positivePercent = ((positiveCount / totalFeedback) * 100).toFixed(0);

            summaryDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%); padding: 1.5rem; border-radius: 0.75rem; color: white;">
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">Average Rating</div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="font-size: 2.5rem; font-weight: 700;">${averageRating}</div>
                        <div>
                            <div style="font-size: 1.5rem;">⭐</div>
                            <div style="font-size: 0.85rem; opacity: 0.9;">out of 5</div>
                        </div>
                    </div>
                </div>

                <div style="background: var(--bg); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--border);">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Total Feedback</div>
                    <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">${totalFeedback}</div>
                    <div style="font-size: 0.9rem; color: var(--text-tertiary); margin-top: 0.25rem;">sessions reviewed</div>
                </div>

                <div style="background: var(--bg); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--border);">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Positive Feedback</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #10B981;">${positivePercent}%</div>
                    <div style="font-size: 0.9rem; color: var(--text-tertiary); margin-top: 0.25rem;">${positiveCount} of ${totalFeedback} (4-5 stars)</div>
                </div>

                <div style="background: var(--bg); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--border);">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.75rem;">Rating Breakdown</div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        ${[5, 4, 3, 2, 1].map(rating => {
                            const count = ratingCounts[rating];
                            const percentage = totalFeedback > 0 ? ((count / totalFeedback) * 100).toFixed(0) : 0;
                            return `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="min-width: 60px; font-size: 0.9rem;">${'⭐'.repeat(rating)}</div>
                                    <div style="flex: 1; background: var(--border); height: 8px; border-radius: 4px; overflow: hidden;">
                                        <div style="background: linear-gradient(90deg, #6366F1, #8B5CF6); height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                                    </div>
                                    <div style="min-width: 50px; text-align: right; font-size: 0.85rem; color: var(--text-secondary);">${count} (${percentage}%)</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // Feedback modal functions
        function showFeedbackModal(feedback) {
            const modal = document.getElementById('feedbackModal');
            const userName = feedback.user_name || 'Unknown User';
            const userEmail = feedback.user_email || 'N/A';
            const stars = '⭐'.repeat(feedback.rating);
            const date = new Date(feedback.timestamp);
            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            const comments = feedback.comments || 'No comments provided';

            document.getElementById('feedbackModalContent').innerHTML = `
                <div class="feedback-modal-header">
                    <div>
                        <h2 style="margin: 0 0 0.5rem 0; color: var(--text-primary);">Feedback Details</h2>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">${formattedDate}</p>
                    </div>
                    <button class="feedback-modal-close" onclick="closeFeedbackModal()">×</button>
                </div>

                <div style="background: var(--bg); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-weight: 600; color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">USER</label>
                        <div style="font-weight: 600; font-size: 1.1rem;">${userName}</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">${userEmail}</div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-weight: 600; color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">RATING</label>
                        <div>
                            <span style="font-size: 1.5rem;">${stars}</span>
                            <span style="margin-left: 0.75rem; font-weight: 700; font-size: 1.25rem; color: var(--primary);">${feedback.rating}/5</span>
                        </div>
                    </div>

                    <div>
                        <label style="display: block; font-weight: 600; color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">COMMENTS</label>
                        <div style="line-height: 1.8; white-space: pre-wrap; color: var(--text-primary);">${comments}</div>
                    </div>
                </div>

                <button onclick="closeFeedbackModal()" style="width: 100%; padding: 0.875rem; background: var(--primary); color: white; border: none; border-radius: 0.75rem; cursor: pointer; font-weight: 600; font-size: 1rem;">
                    Close
                </button>
            `;

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('feedbackModal');
            if (e.target === modal) {
                closeFeedbackModal();
            }
        });

        // Load session overviews
        async function loadSessionOverviews() {
            try {
                const response = await fetch('/api/session-overviews');
                const overviews = await response.json();

                const tbody = document.getElementById('overviewsTable');
                tbody.innerHTML = '';

                if (overviews.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><p>No session overviews yet</p></td></tr>';
                    return;
                }

                // Sort by created date, newest first
                overviews.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                overviews.forEach((overview, index) => {
                    const row = document.createElement('tr');

                    const userName = overview.user_name || 'Unknown';
                    const userEmail = overview.user_email || '';
                    const sessionDate = overview.session_date || 'N/A';

                    // Preview of notes
                    const notes = overview.enhanced_notes || overview.notes || 'No notes';
                    const maxLength = 80;
                    const preview = notes.length > maxLength ? notes.substring(0, maxLength) + '...' : notes;

                    const createdDate = new Date(overview.created_at);
                    const formattedCreated = createdDate.toLocaleDateString() + ' ' + createdDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});

                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${userName}</div>
                            ${userEmail ? `<div style="font-size: 0.85rem; color: var(--text-secondary);">${userEmail}</div>` : ''}
                        </td>
                        <td style="white-space: nowrap;">${sessionDate}</td>
                        <td style="max-width: 300px;">
                            <div style="white-space: normal; line-height: 1.5;">${preview}</div>
                        </td>
                        <td style="white-space: nowrap;">${formattedCreated}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick='showOverviewModal(${JSON.stringify(overview).replace(/'/g, "\\'")} )' style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                    View Full
                                </button>
                                <button onclick='deleteOverview("${overview.booking_id}", "${userName}")' style="padding: 0.5rem 1rem; background: #EF4444; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                    Delete
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading session overviews:', error);
                const tbody = document.getElementById('overviewsTable');
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><p>Error loading overviews</p></td></tr>';
            }
        }

        // Show overview modal
        function showOverviewModal(overview) {
            const modal = document.getElementById('overviewModal');
            const userName = overview.user_name || 'Unknown';
            const userEmail = overview.user_email || '';
            const sessionDate = overview.session_date || 'N/A';
            const createdDate = new Date(overview.created_at);
            const formattedCreated = createdDate.toLocaleDateString() + ' ' + createdDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});

            const rawNotes = overview.notes || '';
            const enhancedNotes = overview.enhanced_notes || '';

            document.getElementById('overviewModalContent').innerHTML = `
                <div class="feedback-modal-header">
                    <div>
                        <h2 style="margin: 0 0 0.5rem 0; color: var(--text-primary);">Session Overview</h2>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">${sessionDate}</p>
                    </div>
                    <button class="feedback-modal-close" onclick="closeOverviewModal()">×</button>
                </div>

                <div style="background: var(--bg); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">STUDENT</label>
                        <div style="font-weight: 600; font-size: 1.1rem;">${userName}</div>
                        ${userEmail ? `<div style="color: var(--text-secondary); font-size: 0.9rem;">${userEmail}</div>` : ''}
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">CREATED</label>
                        <div style="color: var(--text-primary);">${formattedCreated}</div>
                    </div>

                    ${enhancedNotes ? `
                    <div style="margin-bottom: ${rawNotes ? '1.5rem' : '0'};">
                        <label style="display: block; font-weight: 600; color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">AI-ENHANCED SUMMARY (Sent to Student)</label>
                        <div style="background: rgba(99, 102, 241, 0.05); border: 1px solid rgba(99, 102, 241, 0.2); padding: 1rem; border-radius: 0.5rem; line-height: 1.8; white-space: pre-wrap; color: var(--text-primary);">${enhancedNotes}</div>
                    </div>
                    ` : ''}

                    ${rawNotes ? `
                    <div>
                        <label style="display: block; font-weight: 600; color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.5rem;">RAW NOTES</label>
                        <div style="background: var(--bg); border: 1px solid var(--border); padding: 1rem; border-radius: 0.5rem; line-height: 1.8; white-space: pre-wrap; color: var(--text-primary);">${rawNotes}</div>
                    </div>
                    ` : ''}

                    ${!enhancedNotes && !rawNotes ? '<div style="color: var(--text-secondary); font-style: italic;">No notes recorded for this session</div>' : ''}
                </div>

                <button onclick="closeOverviewModal()" style="width: 100%; padding: 0.875rem; background: var(--primary); color: white; border: none; border-radius: 0.75rem; cursor: pointer; font-weight: 600; font-size: 1rem;">
                    Close
                </button>
            `;

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeOverviewModal() {
            const modal = document.getElementById('overviewModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Delete overview
        async function deleteOverview(bookingId, userName) {
            if (!confirm(`Delete session overview for ${userName}?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/session-overviews/${bookingId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('Session overview deleted successfully');
                    loadSessionOverviews(); // Reload the list
                } else {
                    alert('Error: ' + (result.message || 'Failed to delete overview'));
                }
            } catch (error) {
                console.error('Error deleting overview:', error);
                alert('Error deleting overview. Please try again.');
            }
        }

        // Manual overview modal
        function showManualOverviewModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 1rem;
            `;

            modal.innerHTML = `
                <div style="background: var(--surface); border-radius: 1rem; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem;">
                    <h2 style="margin-bottom: 0.5rem; color: var(--text-primary);">Add Manual Session Overview</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">For sessions you've already completed but didn't record at the time.</p>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">Student Name *</label>
                        <input type="text" id="manualUserName" placeholder="John Doe" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.75rem; font-family: inherit; font-size: 0.95rem; background: var(--bg); color: var(--text-primary);">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">Student Email *</label>
                        <input type="email" id="manualUserEmail" placeholder="john@example.com" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.75rem; font-family: inherit; font-size: 0.95rem; background: var(--bg); color: var(--text-primary);">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">Session Date</label>
                        <input type="text" id="manualSessionDate" placeholder="Monday, Dec 18 at 2:00 PM" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 0.75rem; font-family: inherit; font-size: 0.95rem; background: var(--bg); color: var(--text-primary);">
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">Session Notes *</label>
                        <textarea id="manualNotes" placeholder="What did you cover? What tools did you teach? What prompting techniques? What should they practice?..." style="width: 100%; min-height: 200px; padding: 1rem; border: 2px solid var(--border); border-radius: 0.75rem; font-family: inherit; font-size: 0.95rem; resize: vertical; background: var(--bg); color: var(--text-primary);"></textarea>
                    </div>

                    <div style="background: rgba(99, 102, 241, 0.05); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
                            <input type="checkbox" id="manualSendEmail" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: var(--text-primary); font-weight: 500;">Send overview email to student</span>
                        </label>
                        <small style="display: block; margin-top: 0.5rem; margin-left: 1.75rem; color: var(--text-tertiary);">If checked, the notes will be sent to the student's email</small>
                    </div>

                    <div style="display: flex; gap: 0.75rem;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="flex: 1; padding: 0.875rem; background: var(--bg); border: 2px solid var(--border); border-radius: 0.75rem; cursor: pointer; font-weight: 600; color: var(--text-primary);">
                            Cancel
                        </button>
                        <button onclick="submitManualOverview(this.parentElement.parentElement.parentElement)" id="submitManualBtn" style="flex: 1; padding: 0.875rem; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; border: none; border-radius: 0.75rem; cursor: pointer; font-weight: 600; font-size: 1rem;">
                            Save Overview
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.getElementById('manualUserName').focus();
        }

        async function submitManualOverview(modal) {
            const userName = document.getElementById('manualUserName').value.trim();
            const userEmail = document.getElementById('manualUserEmail').value.trim();
            const sessionDate = document.getElementById('manualSessionDate').value.trim();
            const notes = document.getElementById('manualNotes').value.trim();
            const sendEmail = document.getElementById('manualSendEmail').checked;
            const submitBtn = document.getElementById('submitManualBtn');

            // Validation
            if (!userName) {
                alert('Please enter student name');
                return;
            }
            if (!userEmail) {
                alert('Please enter student email');
                return;
            }
            if (!notes) {
                alert('Please enter session notes');
                return;
            }

            // Disable button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 0.5rem;"><span class="spinner" style="border-width: 2px; width: 16px; height: 16px;"></span>Saving...</span>';

            try {
                const response = await fetch('/api/session-overviews/manual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_name: userName,
                        user_email: userEmail,
                        session_date: sessionDate || 'Not specified',
                        notes: notes,
                        send_email: sendEmail
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    modal.remove();
                    alert(`Overview saved successfully!${sendEmail ? '\\n✓ Email sent to student' : ''}`);
                    loadSessionOverviews();
                } else {
                    alert('Error: ' + (result.message || 'Failed to save overview'));
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Overview';
                }
            } catch (error) {
                console.error('Error saving manual overview:', error);
                alert('Failed to save overview: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Overview';
            }
        }

        // Load everything on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
            // loadTimeSlots(); // Now loads only when section is expanded
            loadFeedback();
            loadSessionOverviews();
        });
    </script>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="feedback-modal">
        <div class="feedback-modal-content" id="feedbackModalContent">
        </div>
    </div>

    <!-- Overview Modal -->
    <div id="overviewModal" class="feedback-modal">
        <div class="feedback-modal-content" id="overviewModalContent">
        </div>
    </div>
</body>
</html>
